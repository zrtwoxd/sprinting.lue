local players = game:GetService("Players")

local function bypassWalkSpeed()
    if getgenv().executed then
        print("Walkspeed Already Bypassed - Applying Settings Changes")
        if not getgenv().Enabled then
            return
        end
    else
        getgenv().executed = true
        print("Walkspeed Bypassed")

        local mt = getrawmetatable(game)
        setreadonly(mt, false)

        local oldindex = mt.__index
        mt.__index = newcclosure(function(self, b)
            if b == 'WalkSpeed' then
                return 16  -- Or a higher default value if needed
            end
            return oldindex(self, b)
        end)
    end
end

bypassWalkSpeed()

players.LocalPlayer.CharacterAdded:Connect(function(char)
    bypassWalkSpeed()
    if getgenv().Enabled then -- Apply speed only if enabled
        char:WaitForChild("Humanoid").WalkSpeed = getgenv().Speed or 16 -- Default to 16 if getgenv().Speed is nil
    end
end)

local function updateWalkSpeed()
    local char = players.LocalPlayer.Character
    if char and char:FindFirstChild("Humanoid") then
        if getgenv().Enabled then
            char.Humanoid.WalkSpeed = getgenv().Speed or 16 -- Default to 16 if getgenv().Speed is nil
        else
            char.Humanoid.WalkSpeed = 16 -- Set back to default when disabled
        end
    end
end

-- Initial setup
getgenv().Enabled = false  -- Start disabled
getgenv().Speed = 50 -- Set your desired speed

-- Keybind
local contextActionService = game:GetService("ContextActionService")

local function toggleSpeed(actionName, state, inputObject)
    if actionName == "ToggleWalkSpeed" and state == Enum.UserInputState.Begin then
        getgenv().Enabled = not getgenv().Enabled
        print("WalkSpeed " .. (getgenv().Enabled and "Enabled" or "Disabled"))
        updateWalkSpeed() -- Update walk speed immediately
    end
end

contextActionService:BindAction("ToggleWalkSpeed", toggleSpeed, false, Enum.KeyCode.T)

-- Run the loop only when enabled
while task.wait() do -- Use task.wait() for better performance
  if getgenv().Enabled then
    updateWalkSpeed()
  end
end
